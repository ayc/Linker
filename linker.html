<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<style type="text/css" media="screen">
	body {
		margin: 0;
		cursor: crosshair;
	}
	div.link {
		position: absolute;
		width: 200px; height: 100px;
		background-color: #fcc; opacity: .5;
		outline: 1px solid red;
		font-family: Verdana;
		font-size: 8px;
	}
	#background { margin-bottom: 40px; height: 1004px; }
	#upform {
		position: fixed; clear: both;
		width: 100%;
		margin: 0; padding: 6px;
		bottom: 0; border: none; border-top: 1px solid #666;
		background-color: white; opacity: .8;
	}
	#height { float: right; margin-right: 20px; }
</style>

<title>Linker</title>
<img id="background">
<form id="upform">
	<select id="height">
		<option value="928px">Height: 928px</option>
		<option value="1004px" selected="selected">Height: 1004px</option>
	</select>
	<input id="upfile" type="file">
	<input type="submit" id="next" value="Next">
</form>

<script type="text/javascript" charset="utf-8">

	$('#next').prop('disabled', true);

	window.moveTo(0, 0);
	window.resizeTo( 768, window.screen.availHeight );

	links_window = window.open(
		'blank.html', 'links_window',
		'location=0,status=0,scrollbars=1,width=400,height=800'
	);
	links_window.moveTo(769, 0);
	self.focus();

	var left = -1;
	var top = -1;
	var n_links = 0;

	$('#background').click( function (e) {
		if ( left >= 0 ) {
			var width = e.pageX - left - 1;
			var height = e.pageY - top - 1;
			var dims = '{{' + left + ',' + top + '},{' + width + ',' + height + '}}';
			$('body').append(
				$('<div id="link-' + ++n_links + '" class="link"></div>')
					.css( { left: left, top: top, width: width, height: height } )
			);
			$(links_window.document.getElementById('links'))
				.append( $('<div id="link-' + n_links + '">').text( [
					'<dict>',
					'\t<key>view-type</key>',
					'\t<string>link</string>',
					'\t<key>final-coordinates</key>',
					'\t<string>' + dims + '</string>',
					'\t<key>page-number</key>',
					'\t<string>000</string>',
					'</dict>'
				].join('\n') ) );
			$(links_window.document.getElementById('check')).show();
			left = top = -1;
		} else {
			left = e.pageX;
			top = e.pageY;
		}
	} );
	$('body').on( 'click', 'div.link', function (e) {
		if ( e.altKey ) {
			$(links_window.document.getElementById(this.id)).remove();
			$(this).remove();
			e.stopPropagation();
		}
	} ).on( 'mouseenter', 'div.link', function (e) {
		$(links_window.document.getElementById(this.id)).css( 'color', 'red' );
	} ).on( 'mouseleave', 'div.link', function (e) {
		$(links_window.document.getElementById(this.id)).css( 'color', 'black' );
	} );

	var filename;

	$('#upfile').on( 'change', function (e) {
		$('#next').prop('disabled', false);
		filename = $('#upfile').val();
		filename = filename.split('\\').pop();
		update_image(filename);
	} ).click( function (e) { e.stopPropagation() } );

	$('#next').on( 'click', function (e) {
		var parts = filename.split(/(\d+)/g);
		var last_number;
	  for ( var i=0; i < parts.length; i++ ) {
			if ( ! parts[i].match(/\D+/) ) { last_number = i }
		}
		var num_length = parts[last_number].length;
		parts[last_number]++;
		while ( String(parts[last_number]).length < num_length ) {
			parts[last_number] = '0' + parts[last_number];
		}
		var next = parts.join('');
		filename = next;
		update_image();
		return false;
	} );

	$('#height').on( 'change', function (e) {
		$('#background').css( 'height', $(this).val() );
	} );

	function update_image () {
		$('#background').prop( 'src', encodeURI('JPEGS/' + filename) );
		$(links_window.document.getElementById('links')).empty();
		$('.link').remove();
		$(links_window.document.getElementById('check')).hide();
		update_plist(filename);
	}

	function update_plist (filename) {
		var plistname = filename;
		plistname = plistname.replace( 'jpg', 'plist' );
		$.get( plistname, function (xml) {
			var n_links = 0;
			var xs = new XMLSerializer;
			$(xml).find('array').children().each( function () {
				$(links_window.document.getElementById('links')).append(
					$('<div id="link-' + ++n_links + '"></div')
						.text(xs.serializeToString(this).replace(/ +<\/dict/g, '</dict'))
				);
				$(this).children().each( function () {
					var dims = $(this).text();
					var m = dims.match( /{{(\d+),(\d+)},{(\d+),(\d+)}}/ );
					if ( m ) {
						var link = $('<div id="link-' + n_links + '" class="link"></div>');
						link.append(dims);
						$('body').append(link);
						link.css( { left: m[1], top: m[2], width: m[3], height: m[4] } );
					}
				} );
			} );
		} );
	}



</script>