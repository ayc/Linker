<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<style type="text/css" media="screen">
	body {
		margin: 0;
		background-color: #ddd;
		font-family: Verdana;
		cursor: crosshair;
	}
	div.link {
		position: absolute;
		width: 200px; height: 100px;
		background-color: #fcc; opacity: .5;
		outline: 1px solid red;
		font-family: Verdana;
		font-size: 8px;
	}
	#background { margin-bottom: 40px; height: 1004px; }
	#upform {
		position: fixed; clear: both;
		width: 100%;
		margin: 0; padding: 6px;
		bottom: 0; border: none; border-top: 1px solid #666;
		background-color: white; opacity: .8;
	}
	#upbox {
		position: absolute;
		float: left;
		width: 220px;
		border: 1px inset;
		padding: 3px;
		background-color: #bbb;
		font-size: 12px;
	}
	#upfile { opacity: 0; }
	#height { float: right; margin-right: 20px; }
</style>

<title>Linker</title>
<img id="background">
<form id="upform">
	<select id="height">
		<option value="928px">Height: 928px</option>
		<option value="1004px" selected="selected">Height: 1004px</option>
	</select>
	<div id="upbox">Click or drop file here</div>
	<input id="upfile" type="file">
	<input type="submit" id="prev" class="nav" value="< Prev">
	<input type="submit" id="next" class="nav" value="Next >">
</form>

<script type="text/javascript" charset="utf-8">

	$('.nav').prop('disabled', true);

	window.moveTo(0, 0);
	window.resizeTo( 768, window.screen.availHeight );

	var links_window = open_links_window();
	var ld = links_window.document;
	self.focus();

	var left = -1;
	var top = -1;
	var n_links = 0;

	$('#background').click( function (e) {
		if ( left >= 0 ) {
			var width = e.pageX - left - 1;
			var height = e.pageY - top - 1;
			var dims = '{{' + left + ',' + top + '},{' + width + ',' + height + '}}';
			$('body').append(
				$('<div id="link-' + ++n_links + '" class="link"></div>')
					.css( { left: left, top: top, width: width, height: height } )
			);
			var link = '\t<key>url</key>\n\t<string>http://</string>';
			if ( e.shiftKey ) {
				link = '\t<key>page-number</key>\n\t<integer>000</integer>';
			}
			$(ld.getElementById('links'))
				.append( $('<div id="link-' + n_links + '">')
					.prop( 'contenteditable', true )
					.text( [
						'<dict>',
						'\t<key>view-type</key>',
						'\t<string>link</string>',
						'\t<key>final-coordinates</key>',
						'\t<string>' + dims + '</string>',
						link,
						'</dict>'
					].join('\n') )
				);
			$(ld.getElementById('check')).show();
			left = top = -1;
		} else {
			left = e.pageX;
			top = e.pageY;
		}
	} );
	$('body').on( 'click', 'div.link', function (e) {
		if ( e.altKey ) {
			$(ld.getElementById(this.id)).remove();
			$(this).remove();
			e.stopPropagation();
		}
	} ).on( 'mouseenter', 'div.link', function (e) {
		$(ld.getElementById(this.id)).css( 'color', 'red' );
	} ).on( 'mouseleave', 'div.link', function (e) {
		$(ld.getElementById(this.id)).css( 'color', 'black' );
	} );

	var filename;

	$('#upfile').on( 'change', function (e) {
		$('.nav').prop('disabled', false);
		filename = $('#upfile').val();
		filename = filename.split('\\').pop();
		update_image(filename);
	} ).click( function (e) { e.stopPropagation() } );

	$('#prev').on( 'click', function (e) {
		var n = filename.match( /(\d+)\.jpg/ )[1];
		if ( n > 0 ) {
			filename = filename.replace( /\d+\.jpg/, Number(n) - 1 + '.jpg' );
			update_image();
		}
		return false;
	} );

	$('#next').on( 'click', function (e) {
		var n = filename.match( /(\d+)\.jpg/ )[1];
		filename = filename.replace( /\d+\.jpg/, Number(n) + 1 + '.jpg' );
		update_image();
		return false;
	} );

	$('#height').on( 'change', function (e) {
		$('#background').css( 'height', $(this).val() );
	} );

	function update_image () {
		$('#background').prop( 'src', encodeURI('pages/' + filename) );
		$(ld.getElementById('links')).empty();
		$('.link').remove();
		$(ld.getElementById('check')).hide();
		$('#upbox').text( filename );
		update_plist(filename);
	}

	var xs = new XMLSerializer;

	function update_plist (filename) {
		var plistname = filename;
		plistname = plistname.replace( /\d+\.jpg/, function (s) {
			var s1 = s.replace( /\d+/, function (n) { return ++n } );
			return s1.replace( 'jpg', 'plist' );
		} );
		$.ajax( {
			url: plistname,
			tries: 0,
			success: function (xml) {
				n_links = 0;
				$(xml).find('array').children().each( function () {
					$(ld.getElementById('links')).append(
						$('<div id="link-' + ++n_links + '"></div')
							.text(
								xs.serializeToString(this)
								.replace( /\n\s+/g, '\n\t' )
								.replace( /\t<dict>/, '<dict>' )
								.replace( /\t<\/dict>/, '<dict>' )
							)
					);
					$(ld.getElementById('check')).show();
					$(this).children().each( function () {
						var dims = $(this).text();
						var m = dims.match( /{{(\d+),(\d+)},{(\d+),(\d+)}}/ );
						if ( m ) {
							var link = $('<div id="link-' + n_links + '" class="link"></div>');
							$('body').append(link);
							link.css( { left: m[1], top: m[2], width: m[3], height: m[4] } );
						}
					} );
				} );
			},
			error: function () {
				if( this.tries++ > 2 ) return;
				this.url = this.url.replace( /(\d+\.plist)/, '0$&' );
				$.ajax(this);
			}
		} );
	}

	function open_links_window () {

		var win = window.open(
			'', 'links_window',
			'location=0,status=0,scrollbars=1,width=400,height=800'
		);
		win.moveTo(769, 0);

		var d = win.document;

		d.writeln( '<style type="text/css" media="screen">' );
		d.writeln( '	body { font-family: Verdana; font-size: 12px; margin: 10px; }' );
		d.writeln( '	h2 { font-size: 14px; }' );
		d.writeln( '	#upform {' );
		d.writeln( '		position: fixed; clear: both;' );
		d.writeln( '		width: 100%;' );
		d.writeln( '		margin: 0; padding: 6px; margin-left: -10px;' );
		d.writeln( '		bottom: 0; border: none; border-top: 1px solid #666;' );
		d.writeln( '		background-color: white; opacity: .8;' );
		d.writeln( '	}' );
		d.writeln( '	#links {' );
		d.writeln( '		padding: 6px;' );
		d.writeln( '		border-width: 1px;' );
		d.writeln( '		border-style: inset;' );
		d.writeln( '		background-color: #eee;' );
		d.writeln( '		margin-bottom: 1em;' );
		d.writeln( '	}' );
		d.writeln( '	#links div { margin: 6px; white-space: pre; }' );
		d.writeln( '	span { width: 150px; }' );
		d.writeln( '	#check { display: none; }' );
		d.writeln( '</style>' );
		d.writeln( '' );
		d.writeln( '<title>Links</title>' );
		d.writeln( '<div id="links"></div>' );
		d.writeln( '<div id="check">' );
		d.writeln( '	<input type="checkbox" checked="checked" id="edit">' );
		d.writeln( '	<label for="edit">Editable</label>' );
		d.writeln( '</div>' );
		d.writeln( '' );
		d.writeln( '<div>' );
		d.writeln( '	<h2>How to use this</h2>' );
		d.writeln( '	<p>Put this HTML file in the same directory as the issue plists.</p>' );
		d.writeln( '	<p>First, select an image file with the file upload control in the other window.</p>' );
		d.writeln( '	<p>Then you can define link areas, clicking first on the top left corner and then the bottom right corner. Shift-click for a page-number. Option-click a link area to remove it.</p>' );
		d.writeln( '	<p>Edit the links, then uncheck the "Editable" checkbox so you can copy the text and paste it into the page\'s plist.</p>' );
		d.writeln( '	<p>Finally you can click the "Next" button to load the next numbered image.</p>' );
		d.writeln( '</div>' );
		d.close();

		$('#edit', d).change( function () {
			if ( $('#edit', d).is(':checked') ) {
				$('#links div', d).prop( 'contenteditable', true );
			} else {
				$('#links div', d).prop( 'contenteditable', false ).each( function () {
					var m = $(this).text().match( /{{(\d+),(\d+)},{(\d+),(\d+)}}/ );
					$('#' + this.id).css( { left: m[1], top: m[2], width: m[3], height: m[4] } );
				} );
			}
		} );

		$('#links', d).on( 'mouseenter', 'div', function (e) {
			$('#' + this.id).css( 'outline-width', '5px' );
		} ).on( 'mouseleave', 'div', function (e) {
			$('#' + this.id).css( 'outline-width', '1px' );
		} );

		return win;
	}

</script>