<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<style type="text/css" media="screen">
	body { font-family: Verdana; font-size: 12px; margin: 10px; }
	h2 { font-size: 14px; }
	#upform {
		position: fixed; clear: both;
		width: 100%;
		margin: 0; padding: 6px; margin-left: -10px;
		bottom: 0; border: none; border-top: 1px solid #666;
		background-color: white; opacity: .8;
	}
	#links {
		padding: 6px;
		border-width: 1px;
		border-style: inset;
		background-color: #eee;
		margin-bottom: 1em;
	}
	#links div { margin: 6px; white-space: pre; }
	span { width: 150px; }
	#check { display: none; }
</style>

<title>Links</title>
<div id="links"></div>
<div id="check">
	<input type="checkbox" id="edit">
	<label for="edit">Editable</label>
</div>

<div>
	<h2>How to use this</h2>
	<p>(You may have to put these HTML files in the same directory as the images.)</p>
	<p>First, select an image file with the file upload control in the other window.</p>
	<p>Then you can define link areas, clicking first on the top left corner and then the bottom right corner. Option-click a link area to remove it.</p>
	<p>Click the "Editable" checkbox above to edit the page-numbers (replacing some with URLs), then uncheck it again so you can copy the text and paste it into the page's plist.</p>
	<p>Finally you can click the "Next" button to load the next numbered image.</p>
</div>

<form id="upform">
	<input id="upfile" type="file">
	<input type="submit" id="next" value="Next">
</form>

<script type="text/javascript" charset="utf-8">

$('#edit').change( function () {
	$('#links div').prop( 'contenteditable', $('#edit').is(':checked') );
} );

$('#links').on( 'mouseenter', 'div', function (e) {
	$(window.opener.document.getElementById(this.id)).css( 'outline-width', '5px' );
} ).on( 'mouseleave', 'div', function (e) {
	$(window.opener.document.getElementById(this.id)).css( 'outline-width', '1px' );
} );

$('#upfile').on( 'change', function (e) {
	var name = $('#upfile').val();
	if ( name.match(/fakepath/) ) name = name.split('\\').pop();
	$.get( name, function (xml) {
		var n_links = 0;
		var xs = new XMLSerializer;
		$(xml).find('array').children().each( function () {
			$('#links').append(
				$('<div id="link-' + ++n_links + '"></div')
					.text(xs.serializeToString(this).replace(/ +<\/dict/g, '</dict'))
			);
			$(this).children().each( function () {
				var dims = $(this).text();
				var m = dims.match( /{{(\d+),(\d+)},{(\d+),(\d+)}}/ );
				if ( m ) {
					var link = $('<div id="link-' + n_links + '" class="link"></div>');
					link.append(dims);
					$(window.opener.document.body).append(link);
					link.css( { left: m[1], top: m[2], width: m[3], height: m[4] } );
				}
			} );
		} );
	} );
} );

</script>